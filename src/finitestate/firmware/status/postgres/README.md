# FWAN Status Database Initial Loader

This script creates and fills the initial tables in the fwan-status-{STAGE} DB.

## New Migrations

Under the hood, we use Alembic + SQLAlchemy to generate all database objects and keep them in sync.
To create a change to the fwan PostgreSQL database:

- Update the current dev/test database with: `run_loader.sh`
- Make your desired database changes to _postgres/model.py_
- Generate the new revision with: `alembic revision --autogenerate -m '<migration name>'`
- Edit the autogenerated new revision in the _postgres/alembic/versions_ directory
- Update the database with the new revision by running: `run_loader.sh`

To revert any changes made by your revision, you can revert back easily with: `alembic downgrade -1`, or can specify the exact revision number to downgrade to (instead of back one with -1)

## Running Database Population

Execution of this script must be done from machine with access to RDS.
Running this script is done via:

```
python3 -m venv venv
source venv/bin/activate
pip3 install -r requirements.txt

run_loader.sh
```

The following variables should be set within run_loader.sh:
*AWS_DEFAULT_REGION
*STAGE

## Table Description

The tables are generated the following way:

### PROCESS_STATUS_DETAIL

Detailed transaction table on every status received by the system

```
CREATE SEQUENCE process_status_detail_status_id_seq;

CREATE TABLE process_status_detail (
    status_id BIGINT DEFAULT nextval('process_status_detail_status_id_seq'::regclass) NOT NULL,
    fwan_process_id UUID,
    file_id TEXT,
    component_id TEXT,
    status TEXT,
    status_date TIMESTAMP WITH TIME ZONE,
    PRIMARY KEY (status_id)
);

CREATE INDEX process_status_detail_idx ON process_status_detail (fwan_process_id, file_id, component_id, status);
```

Where:

- `status_id` is an auto-generated BIGINT key
- `fwan_process_id` is a system-generated UUID to track processing job per-firmware
- `file_id` is the SHA-256 hash of the file (should be 64 characters long)
- `component_id` is the common lowercase plugin or process name ('binary_analysis', 'file_type', etc)
- `status` is short, enumerated status ('QUEUED', 'PROCESSING', 'DONE', 'ERROR', etc)
- `status_date` is the timestamp the status was reported (not entered in the database, because of queue latency)

### ERROR_DETAIL

High-level error table with brief details received from the components

```
CREATE TABLE error_detail (
    status_id BIGINT NOT NULL,
    details JSONB,
    PRIMARY KEY (status_id),
    FOREIGN KEY(status_id) REFERENCES process_status_detail (status_id)
);
```

Where:

- `status_id` is foreign key describing which status generated the error
- `details` is a JSON text object that describes details of the error (user-defineable)

### ACTIVE_COMPONENT

Table listing all expected components and files to be run to DONE/ERROR status

```
CREATE TABLE active_component (
    fwan_process_id UUID NOT NULL,
    file_id TEXT NOT NULL,
    component_id TEXT NOT NULL,
    active_start_date TIMESTAMP WITH TIME ZONE NOT NULL,
    PRIMARY KEY (fwan_process_id, file_id, component_id)
);

CREATE INDEX active_component_start_idx ON active_component (active_start_date);
```

Where:

- `fwan_process_id` is a system-generated UUID to track processing job per-firmware
- `file_id` is the SHA-256 hash of the file (should be 64 characters long)
- `component_id` is the common lowercase plugin or process name ('binary_analysis', 'file_type', etc)
- `active_start_date` is the timestamp of when this component was QUEUED

### EXPIRED_COMPONENT

Table listing all components that timed out from active_component (> 1 day)

```
CREATE TABLE expired_component (
    fwan_process_id UUID NOT NULL,
    file_id TEXT NOT NULL,
    component_id TEXT NOT NULL,
    expired_date TIMESTAMP WITH TIME ZONE NOT NULL,
    PRIMARY KEY (fwan_process_id, file_id, component_id)
);

CREATE INDEX expired_component_idx ON expired_component (expired_date);
```

Where:

- `fwan_process_id` is a system-generated UUID to track processing job per-firmware
- `file_id` is the SHA-256 hash of the file (should be 64 characters long)
- `component_id` is the common lowercase plugin or process name ('binary_analysis', 'file_type', etc)
- `expired_date` is the timestamp of when this component was expired

### ACTIVE_PROCESS

Table tracking unpack jobs that have completed and are waiting on downstream analysis/rollups

```
CREATE TYPE activestage AS ENUM ('ANALYSIS');

CREATE TABLE active_process (
    fwan_process_id UUID NOT NULL,
    file_id TEXT NOT NULL,
    active_stage activestage NOT NULL,
    active_start_date TIMESTAMP WITH TIME ZONE NOT NULL,
    PRIMARY KEY (fwan_process_id, file_id)
);

CREATE INDEX active_process_start_idx ON active_process (active_start_date);
```

Where:

- `fwan_process_id` is a system-generated UUID to track processing job per-firmware
- `file_id` is the SHA-256 hash of the firmware that generated this process (should be 64 characters long)
- `active_stage` is an enumeration of current stage (ANALYSIS is the only value, but will expand to RISK_ROLLUP, CVE_ROLLUP, etc)
- `active_start_date` is the timestamp of when unpack finished for ANALYSIS, and will reflect dates with new stages as well
